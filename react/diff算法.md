

react 组件更新时组件渲染当DOM结构发生变化时，使用js操作DOM开销非常高（涉及到线程间通信），react提供了virtual DOM；为了避免每次更新组件DOM结构全部销毁、渲染一遍，react提供了高效的diff算法，帮助用户找出virtual DOM中真正变化的部分，并只针对该部分进行实际DOM操作，而非重新渲染整个页面。

#### 精确的diff算法

- 计算一个树形结构转换成另一个树形结构所需的最少操作是diff算法要解决的问题，可是为了得到理想状态的最少操作，时间复杂度高达O(n^3)， 意味着如果计算两棵1000个节点的树形结构，要进行的比较是10^9级别的，对于前端刷新频繁的页面来说这种复杂度的算法是计算机、用户都无法承受的。

#### react的diff算法

> 启发式算法指人在解决问题时所采取的一种根据经验规则进行发现的方法。其特点是在解决问题时,利用过去的经验,选择已经行之有效的方法，而不是系统地、以确定的步骤去寻求答案。

- react 的diff算法使用了启发式算法，无需得到最精确的答案，只需得到能优化大部分更新操作的方式就可以了，排除低频更新方式，但是也要兼容，使用这种方式后将O(n^3) 复杂度的问题转换成了O(n) 复杂度的问题

#### react diff策略

1. 一般不会对元素/组件进行跨层级的操作

2. 一般不同类型的元素或不同类型的组件结构不同，相同类型的元素或组件会生成相似的树形结构

3. 对于同级的元素，可以使用唯一key值进行区分

基于以上三个前提策略，React 分别对 tree diff、component diff 以及 element diff 进行算法优化，事实也证明这三个前提策略是合理且准确的，它保证了整体界面构建的性能。

##### tree diff

基于策略一，react对树进行分层比较，两棵树只会对同一层次的节点进行比较，如果同一层级的节点已经不存在，那么这一节点和它的子节点都会被删除，不会再去寻找是否这个节点移动到了其它层级而将其移动过去，如果有移动的情况，那么将会将原有位置的DOM删除，在新位置新建一个DOM结构。

![image](https://note.youdao.com/yws/public/resource/0633cbf2aa26668397bba317c1fbf567/xmlnote/WEBRESOURCEd0ae3d5acb85fc41652ab3f7b5cfbeb2/6107)

对于通过数组动态创建的一组元素，react会要求开发者为每个元素提供唯一标识来为更新过程减轻负担，不提供就warning，但是还是能正常渲染，但是如果开发者提供了错误的key值，react会根据默认的原则渲染出出乎意料的结果。

更新前后：

- key值有变化，删除key值不存在的节点，创建新增key值的节点，这两种方式都不会向下层节点再比较。

- key值没有变化，比较节点属性，判断是否需要更新，下层节点会进行比较。

由更新过程的表现可以得出：key值要**稳定**，不能用不可预测的random，这样会导致即使更新前后没有变化的元素key值改变而强制删除新建，影响性能。

除此之外，key值还要**唯一**，react把key值不唯一的后果让开发者自己承担：react认为开发者会对同一组元素提供不同的key值，如果提供的key值有重复，那么就只展示相同key值中的第一个元素，导致数据展示不全的问题。
